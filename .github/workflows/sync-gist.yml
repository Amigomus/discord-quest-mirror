name: Sync Gist

on:
  schedule:
    - cron: '0 * * * *'  # Run every hour
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download and extract code
        run: |
          # Download the markdown file
          curl -s https://gist.githubusercontent.com/aamiaa/204cd9d42013ded9faf646fae7f89fbb/raw/ -o temp.md
          
          # Extract the JavaScript code between ```js and ```
          sed -n '/```js/,/```/p' temp.md | sed '1d;$d' > CompleteDiscordQuest.js
          
          # Clean up
          rm temp.md
          
      - name: Check if file changed
        id: check_changes
        run: |
          # Download current release asset if exists
          curl -sL https://github.com/${{ github.repository }}/releases/download/latest/CompleteDiscordQuest.js -o current.js 2>/dev/null || touch current.js
          
          if diff -q CompleteDiscordQuest.js current.js >/dev/null 2>&1; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Create new release
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          export TZ='Asia/Riyadh'  # GMT+3
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          READABLE_DATE=$(date '+%Y-%m-%d %H:%M:%S %Z')
          gh release create "v$TIMESTAMP" CompleteDiscordQuest.js \
            --title "Discord Quest Code - $TIMESTAMP" \
            --notes "Auto-updated on $READABLE_DATE" \
            --latest
        env:
          GH_TOKEN: ${{ github.token }}
